From 79bbe974dcb5e1494fbe0cc12f5265dc8ae068cf Mon Sep 17 00:00:00 2001
From: Rui Salvaterra <rsalvaterra@gmail.com>
Date: Fri, 7 Jan 2022 20:39:47 +0000
Subject: [PATCH] iptables: remove support for pre-git kernel versions

We don't need this at all.

Signed-off-by: Rui Salvaterra <rsalvaterra@gmail.com>
---
 extensions/libip6t_DNAT.c |  1 -
 extensions/libip6t_SNAT.c |  1 -
 extensions/libipt_DNAT.c  |  8 ++------
 extensions/libipt_SNAT.c  |  8 ++------
 include/xtables.h         |  8 --------
 libxtables/xtables.c      | 17 -----------------
 6 files changed, 4 insertions(+), 39 deletions(-)

diff --git a/extensions/libip6t_DNAT.c b/extensions/libip6t_DNAT.c
index 89c5ceb1..a69cea58 100644
--- a/extensions/libip6t_DNAT.c
+++ b/extensions/libip6t_DNAT.c
@@ -10,7 +10,6 @@
 #include <string.h>
 #include <stdlib.h>
 #include <xtables.h>
-#include <iptables.h>
 #include <limits.h> /* INT_MAX in ip_tables.h */
 #include <linux/netfilter_ipv6/ip6_tables.h>
 #include <linux/netfilter/nf_nat.h>
diff --git a/extensions/libip6t_SNAT.c b/extensions/libip6t_SNAT.c
index 7d74b3d7..d5338b56 100644
--- a/extensions/libip6t_SNAT.c
+++ b/extensions/libip6t_SNAT.c
@@ -10,7 +10,6 @@
 #include <string.h>
 #include <stdlib.h>
 #include <xtables.h>
-#include <iptables.h>
 #include <limits.h> /* INT_MAX in ip_tables.h */
 #include <linux/netfilter_ipv6/ip6_tables.h>
 #include <linux/netfilter/nf_nat.h>
diff --git a/extensions/libipt_DNAT.c b/extensions/libipt_DNAT.c
index 4907a2e8..9ad0efdf 100644
--- a/extensions/libipt_DNAT.c
+++ b/extensions/libipt_DNAT.c
@@ -3,7 +3,6 @@
 #include <string.h>
 #include <stdlib.h>
 #include <xtables.h>
-#include <iptables.h> /* get_kernel_version */
 #include <limits.h> /* INT_MAX in ip_tables.h */
 #include <linux/netfilter_ipv4/ip_tables.h>
 #include <linux/netfilter/nf_nat.h>
@@ -176,11 +175,8 @@ static void DNAT_parse(struct xt_option_call *cb)
 	switch (cb->entry->id) {
 	case O_TO_DEST:
 		if (cb->xflags & F_X_TO_DEST) {
-			if (!kernel_version)
-				get_kernel_version();
-			if (kernel_version > LINUX_VERSION(2, 6, 10))
-				xtables_error(PARAMETER_PROBLEM,
-					   "DNAT: Multiple --to-destination not supported");
+			xtables_error(PARAMETER_PROBLEM,
+				   "DNAT: Multiple --to-destination not supported");
 		}
 		*cb->target = parse_to(cb->arg, portok, info);
 		cb->xflags |= F_X_TO_DEST;
diff --git a/extensions/libipt_SNAT.c b/extensions/libipt_SNAT.c
index e92d811c..a215c0d8 100644
--- a/extensions/libipt_SNAT.c
+++ b/extensions/libipt_SNAT.c
@@ -3,7 +3,6 @@
 #include <string.h>
 #include <stdlib.h>
 #include <xtables.h>
-#include <iptables.h>
 #include <limits.h> /* INT_MAX in ip_tables.h */
 #include <linux/netfilter_ipv4/ip_tables.h>
 #include <linux/netfilter/nf_nat.h>
@@ -170,11 +169,8 @@ static void SNAT_parse(struct xt_option_call *cb)
 	switch (cb->entry->id) {
 	case O_TO_SRC:
 		if (cb->xflags & F_X_TO_SRC) {
-			if (!kernel_version)
-				get_kernel_version();
-			if (kernel_version > LINUX_VERSION(2, 6, 10))
-				xtables_error(PARAMETER_PROBLEM,
-					   "SNAT: Multiple --to-source not supported");
+			xtables_error(PARAMETER_PROBLEM,
+				   "SNAT: Multiple --to-source not supported");
 		}
 		*cb->target = parse_to(cb->arg, portok, info);
 		cb->xflags |= F_X_TO_SRC;
diff --git a/include/xtables.h b/include/xtables.h
index df1eaee3..69e19385 100644
--- a/include/xtables.h
+++ b/include/xtables.h
@@ -599,14 +599,6 @@ static inline void xtables_print_mark_mask(unsigned int mark,
 extern const struct xtables_pprot xtables_chain_protos[];
 extern uint16_t xtables_parse_protocol(const char *s);
 
-/* kernel revision handling */
-extern int kernel_version;
-extern void get_kernel_version(void);
-#define LINUX_VERSION(x,y,z)	(0x10000*(x) + 0x100*(y) + z)
-#define LINUX_VERSION_MAJOR(x)	(((x)>>16) & 0xFF)
-#define LINUX_VERSION_MINOR(x)	(((x)>> 8) & 0xFF)
-#define LINUX_VERSION_PATCH(x)	( (x)      & 0xFF)
-
 /* xtoptions.c */
 extern void xtables_option_metavalidate(const char *,
 					const struct xt_option_entry *);
diff --git a/libxtables/xtables.c b/libxtables/xtables.c
index bc42ba82..053f5177 100644
--- a/libxtables/xtables.c
+++ b/libxtables/xtables.c
@@ -2304,23 +2304,6 @@ void xtables_print_val_mask(unsigned int val, unsigned int mask,
 	printf(" 0x%x", val);
 }
 
-int kernel_version;
-
-void get_kernel_version(void)
-{
-	static struct utsname uts;
-	int x = 0, y = 0, z = 0;
-
-	if (uname(&uts) == -1) {
-		fprintf(stderr, "Unable to retrieve kernel version.\n");
-		xtables_free_opts(1);
-		exit(1);
-	}
-
-	sscanf(uts.release, "%d.%d.%d", &x, &y, &z);
-	kernel_version = LINUX_VERSION(x, y, z);
-}
-
 #include <linux/netfilter/nf_tables.h>
 
 struct xt_xlate {
-- 
2.34.1

