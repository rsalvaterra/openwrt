From 82880c4a6224f9e537d106b3bfe079c792bd9f09 Mon Sep 17 00:00:00 2001
From: Rui Salvaterra <rsalvaterra@gmail.com>
Date: Wed, 28 Oct 2020 14:02:43 +0000
Subject: [PATCH] ath9k: implement ADC entropy collection for older generations

Signed-off-by: Rui Salvaterra <rsalvaterra@gmail.com>
---
 drivers/net/wireless/ath/ath9k/ar5008_phy.c | 34 +++++++++++++++++++++
 drivers/net/wireless/ath/ath9k/ar9002_phy.h | 13 +++++++-
 drivers/net/wireless/ath/ath9k/ar9003_phy.c | 32 +++++++++++++++++++
 drivers/net/wireless/ath/ath9k/hw.h         |  5 +++
 drivers/net/wireless/ath/ath9k/rng.c        | 34 ++++++---------------
 5 files changed, 92 insertions(+), 26 deletions(-)

Index: backports-6.6.15/drivers/net/wireless/ath/ath9k/ar5008_phy.c
===================================================================
--- backports-6.6.15.orig/drivers/net/wireless/ath/ath9k/ar5008_phy.c
+++ backports-6.6.15/drivers/net/wireless/ath/ath9k/ar5008_phy.c
@@ -1340,9 +1340,38 @@ void ar5008_hw_init_rate_txpower(struct
 	}
 }
 
+static int __maybe_unused
+ar5008_hw_get_adc_entropy(struct ath_hw *ah, u32 *buf, const u32 buf_size, u32 *rng_last)
+{
+	int i, j;
+	u32 v1, v2, last = *rng_last;
+
+	REG_RMW_FIELD(ah, AR_PHY_TEST(ah), AR_PHY_TEST_BBB_OBS_SEL, 1);
+	REG_CLR_BIT(ah, AR_PHY_TEST(ah), AR_PHY_TEST_RX_OBS_SEL_BIT5);
+	REG_RMW_FIELD(ah, AR_PHY_TEST2, AR_PHY_TEST2_RX_OBS_SEL, 0);
+
+	for (i = 0, j = 0; i < buf_size; i++) {
+		v1 = REG_READ(ah, AR_PHY_TST_ADC) & 0xffff;
+		v2 = REG_READ(ah, AR_PHY_TST_ADC) & 0xffff;
+
+		/* wait for data ready */
+		if (v1 && v2 && last != v1 && v1 != v2 && v1 != 0xffff &&
+		    v2 != 0xffff)
+			buf[j++] = (v1 << 16) | v2;
+
+		last = v2;
+	}
+
+	*rng_last = last;
+
+	return j << 2;
+}
+
 int ar5008_hw_attach_phy_ops(struct ath_hw *ah)
 {
 	struct ath_hw_private_ops *priv_ops = ath9k_hw_private_ops(ah);
+	struct ath_hw_ops *ops __maybe_unused;
+
 	static const u32 ar5416_cca_regs[6] = {
 		AR_PHY_CCA,
 		AR_PHY_CH1_CCA,
@@ -1357,6 +1386,11 @@ int ar5008_hw_attach_phy_ops(struct ath_
 	if (ret)
 	    return ret;
 
+#ifdef CPTCFG_ATH9K_HWRNG
+	ops = ath9k_hw_ops(ah);
+	ops->get_adc_entropy = ar5008_hw_get_adc_entropy;
+#endif
+
 	priv_ops->rf_set_freq = ar5008_hw_set_channel;
 	priv_ops->spur_mitigate_freq = ar5008_hw_spur_mitigate;
 
Index: backports-6.6.15/drivers/net/wireless/ath/ath9k/ar9002_phy.h
===================================================================
--- backports-6.6.15.orig/drivers/net/wireless/ath/ath9k/ar9002_phy.h
+++ backports-6.6.15/drivers/net/wireless/ath/ath9k/ar9002_phy.h
@@ -16,10 +16,16 @@
 #ifndef AR9002_PHY_H
 #define AR9002_PHY_H
 
-#define AR_PHY_TEST             0x9800
+#define AR_PHY_TEST(_ah)             0x9800
 #define PHY_AGC_CLR             0x10000000
 #define RFSILENT_BB             0x00002000
 
+#define AR_PHY_TEST_BBB_OBS_SEL       0x780000
+#define AR_PHY_TEST_BBB_OBS_SEL_S     19
+
+#define AR_PHY_TEST_RX_OBS_SEL_BIT5_S 23
+#define AR_PHY_TEST_RX_OBS_SEL_BIT5   (1 << AR_PHY_TEST_RX_OBS_SEL_BIT5_S)
+
 #define AR_PHY_TURBO                0x9804
 #define AR_PHY_FC_TURBO_MODE        0x00000001
 #define AR_PHY_FC_TURBO_SHORT       0x00000002
@@ -36,6 +42,9 @@
 
 #define AR_PHY_TEST2			0x9808
 
+#define AR_PHY_TEST2_RX_OBS_SEL        0x3C00
+#define AR_PHY_TEST2_RX_OBS_SEL_S      10
+
 #define AR_PHY_TIMING2           0x9810
 #define AR_PHY_TIMING3           0x9814
 #define AR_PHY_TIMING3_DSC_MAN   0xFFFE0000
@@ -393,6 +402,8 @@
 #define AR_PHY_RFBUS_GRANT       0x9C20
 #define AR_PHY_RFBUS_GRANT_EN    0x00000001
 
+#define AR_PHY_TST_ADC      0x9C24
+
 #define AR_PHY_CHAN_INFO_GAIN_DIFF             0x9CF4
 #define AR_PHY_CHAN_INFO_GAIN_DIFF_UPPER_LIMIT 320
 
Index: backports-6.6.15/drivers/net/wireless/ath/ath9k/ar9003_phy.c
===================================================================
--- backports-6.6.15.orig/drivers/net/wireless/ath/ath9k/ar9003_phy.c
+++ backports-6.6.15/drivers/net/wireless/ath/ath9k/ar9003_phy.c
@@ -1918,6 +1918,33 @@ void ar9003_hw_init_rate_txpower(struct
 	}
 }
 
+static int __maybe_unused
+ar9003_hw_get_adc_entropy(struct ath_hw *ah, u32 *buf, const u32 buf_size, u32 *rng_last)
+{
+	int i, j;
+	u32  v1, v2, last = *rng_last;
+
+	REG_RMW_FIELD(ah, AR_PHY_TEST(ah), AR_PHY_TEST_BBB_OBS_SEL, 1);
+	REG_CLR_BIT(ah, AR_PHY_TEST(ah), AR_PHY_TEST_RX_OBS_SEL_BIT5);
+	REG_RMW_FIELD(ah, AR_PHY_TEST_CTL_STATUS(ah), AR_PHY_TEST_CTL_RX_OBS_SEL, 0);
+
+	for (i = 0, j = 0; i < buf_size; i++) {
+		v1 = REG_READ(ah, AR_PHY_TST_ADC) & 0xffff;
+		v2 = REG_READ(ah, AR_PHY_TST_ADC) & 0xffff;
+
+		/* wait for data ready */
+		if (v1 && v2 && last != v1 && v1 != v2 && v1 != 0xffff &&
+		    v2 != 0xffff)
+			buf[j++] = (v1 << 16) | v2;
+
+		last = v2;
+	}
+
+	*rng_last = last;
+
+	return j << 2;
+}
+
 void ar9003_hw_attach_phy_ops(struct ath_hw *ah)
 {
 	struct ath_hw_private_ops *priv_ops = ath9k_hw_private_ops(ah);
@@ -1963,6 +1990,11 @@ void ar9003_hw_attach_phy_ops(struct ath
 #ifdef CPTCFG_ATH9K_BTCOEX_SUPPORT
 	ops->set_bt_ant_diversity = ar9003_hw_set_bt_ant_diversity;
 #endif
+
+#ifdef CPTCFG_ATH9K_HWRNG
+	ops->get_adc_entropy = ar9003_hw_get_adc_entropy;
+#endif
+
 	ops->tx99_start = ar9003_hw_tx99_start;
 	ops->tx99_stop = ar9003_hw_tx99_stop;
 	ops->tx99_set_txpower = ar9003_hw_tx99_set_txpower;
Index: backports-6.6.15/drivers/net/wireless/ath/ath9k/hw.h
===================================================================
--- backports-6.6.15.orig/drivers/net/wireless/ath/ath9k/hw.h
+++ backports-6.6.15/drivers/net/wireless/ath/ath9k/hw.h
@@ -726,6 +726,7 @@ struct ath_spec_scan {
  * @spectral_scan_config: set parameters for spectral scan and enable/disable it
  * @spectral_scan_trigger: trigger a spectral scan run
  * @spectral_scan_wait: wait for a spectral scan run to finish
+ * @get_adc_entropy: get entropy from the raw ADC I/Q output
  */
 struct ath_hw_ops {
 	void (*config_pci_powersave)(struct ath_hw *ah,
@@ -757,6 +758,10 @@ struct ath_hw_ops {
 #ifdef CPTCFG_ATH9K_BTCOEX_SUPPORT
 	void (*set_bt_ant_diversity)(struct ath_hw *hw, bool enable);
 #endif
+
+#ifdef CPTCFG_ATH9K_HWRNG
+	int (*get_adc_entropy)(struct ath_hw *ah, u32 *buf, const u32 buf_size, u32 *rng_last);
+#endif
 };
 
 struct ath_nf_limits {
Index: backports-6.6.15/drivers/net/wireless/ath/ath9k/rng.c
===================================================================
--- backports-6.6.15.orig/drivers/net/wireless/ath/ath9k/rng.c
+++ backports-6.6.15/drivers/net/wireless/ath/ath9k/rng.c
@@ -19,37 +19,25 @@
 
 #include "ath9k.h"
 #include "hw.h"
-#include "ar9003_phy.h"
+
+static inline int ath9k_hw_get_adc_entropy(struct ath_hw *ah,
+	u32 *buf, const u32 buf_size, u32 *rng_last)
+{
+	return ath9k_hw_ops(ah)->get_adc_entropy(ah, buf, buf_size, rng_last);
+}
 
 static int ath9k_rng_data_read(struct ath_softc *sc, u32 *buf, u32 buf_size)
 {
-	int i, j;
-	u32  v1, v2, rng_last = sc->rng_last;
 	struct ath_hw *ah = sc->sc_ah;
+	int bytes_read;
 
 	ath9k_ps_wakeup(sc);
 
-	REG_RMW_FIELD(ah, AR_PHY_TEST(ah), AR_PHY_TEST_BBB_OBS_SEL, 1);
-	REG_CLR_BIT(ah, AR_PHY_TEST(ah), AR_PHY_TEST_RX_OBS_SEL_BIT5);
-	REG_RMW_FIELD(ah, AR_PHY_TEST_CTL_STATUS(ah), AR_PHY_TEST_CTL_RX_OBS_SEL, 0);
-
-	for (i = 0, j = 0; i < buf_size; i++) {
-		v1 = REG_READ(ah, AR_PHY_TST_ADC) & 0xffff;
-		v2 = REG_READ(ah, AR_PHY_TST_ADC) & 0xffff;
-
-		/* wait for data ready */
-		if (v1 && v2 && rng_last != v1 && v1 != v2 && v1 != 0xffff &&
-		    v2 != 0xffff)
-			buf[j++] = (v1 << 16) | v2;
-
-		rng_last = v2;
-	}
+	bytes_read = ath9k_hw_get_adc_entropy(ah, buf, buf_size, &sc->rng_last);
 
 	ath9k_ps_restore(sc);
 
-	sc->rng_last = rng_last;
-
-	return j << 2;
+	return bytes_read;
 }
 
 static u32 ath9k_rng_delay_get(u32 fail_stats)
@@ -95,14 +83,10 @@ static int ath9k_rng_read(struct hwrng *
 void ath9k_rng_start(struct ath_softc *sc)
 {
 	static atomic_t serial = ATOMIC_INIT(0);
-	struct ath_hw *ah = sc->sc_ah;
 
 	if (sc->rng_ops.read)
 		return;
 
-	if (!AR_SREV_9300_20_OR_LATER(ah))
-		return;
-
 	snprintf(sc->rng_name, sizeof(sc->rng_name), "ath9k_%u",
 		 (atomic_inc_return(&serial) - 1) & U16_MAX);
 	sc->rng_ops.name = sc->rng_name;
